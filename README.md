# quakecw_workflow
CWNU Earthquake Research Group's Adaptation of QuakeCoRE NZ workflow

Korean Ground Motion Simulation @ Nurion

Changelog

- x2319a02 계정으로 이전
- Plot_ts, IM_plots이 워크플로우에 구현


# 시뮬레이션


## 시뮬레이션 준비

우선 단층 모델과 속도 모델은 준비되어 있다고 가정하고 시뮬레이션 실행에 초점을 두겠습니다. 단층모델과 속도모델 만드는 과정은 조속히 문서화 하도록 하겠습니다.

시뮬레이션 실행 root 디렉토리가 아래와 같다고 가정하고 진행함.

/scratch/x2319a02/gmsim/RunFolder/Busan20211214 ---------- (1)

단층 모델과 속도 모델은 별도 레퍼런스로 보관중인 /scratch/x2319a02/gmsim/Busan_Data/Data를 사용할 것임.

위 (1) 디렉토리에 심볼릭 링크를 만듬

| cd /scratch/x2319a02/gmsim/RunFolder/Busan20211214ln -s /scratch/x2319a02/gmsim/Busan_Data/Data . |
| ------------------------------------------------------------------------------------------------- |

이 디렉토리에 Data 디렉토리가 있고, 그 아래 위에서 만든 단층모델과 속도모델이 이같은 구조로 배치되어 있어야 함.

| ---------------------------------------------------------------------------------------------------------------- |
| Data\ |
|-Sources\ |
| \|-Pohang\ |
| \| \|-Stoch\ |
| \| \| \|-Pohang.stoch\ |
| \| \|-setSrfParams.py\|
| \| \|-Srf\ |
| \| \| \|-Pohang.gsf\
| \| \| \|-Pohang.srf\
| \| \| \|-Pohang.info\
| \| \| \|-Pohang.SEED\
| \|-Gyeongju\
| \| \|-Stoch\
| \| \| \|-Gyeongju.stoch\
| \| \|-setSrfParams.py\
| \| \|-Srf\
| \| \| \|-Gyeongju.srf\
| \| \| \|-Gyeongju.gsf\
| \| \| \|-Gyeongju.info\
| \| \| \|-Gyeongju.SEED\
|-VMs\
| \|-Pohang\
| \| \|-vm_params.yaml\
| \| \|-nzvm.cfg\
| \| \|-vp3dfile.p\
| \| \|-vs3dfile.s\
| \| \|-rho3dfile.d\
| \| \|-in_basin_mask.b\
| \| \|-model_bounds_rt01-h0.100\
| \| \|-model_coords_rt01-h0.100\
| \| \|-model_params_rt01-h0.100\
| \| \|-gridfile_rt01-h0.100\
| \| \|-gridout_rt01-h0.100\
| \| \|-VeloModCorners.txt\
| \|-Gyeongju (VMs/Pohang의 심볼릭 링크)    
|
| ---------------------------------------------------------------------------------------------------------------- |

Sources에서 단층 이름을 한 srf파일과 매칭되는 stoch파일이 존재하여야 하며 (예: Pohang.srf, Pohang.stoch)

VMs의 경우 .p,.s,.d 속도모델 파일과 좌표관련 파일들이 단층과 같은 이름을 한 폴더안에 보관되어 있어야 함. 같은 속도모델을 이용할 경우, 심볼릭 링크를 사용해도 무방.

  


가상 환경을 활성화시킴

activate_env /home01/x2319a02/gmsim/Environments/v211213/

  


| 참고activate_env 콤맨드는 /home01/x2319a02/gmsim/share/bashrc.uceq 에 정의되어 있음..bashrc에 source /home01/x2319a02/gmsim/share/bashrc.uceq 를 추가하는 것을 추천함.      아래와 같은 에러가 자주 목격되는데, 무해한 것으로 보임      x2319a02@login04:/scratch/x2319a02/gmsim/RunFolder/Busan20211214> activate_env /home01/x2319a02/gmsim/Environments/v211213/cray-impi/1.1.4(154):ERROR:102: Tcl command execution failed: set CompilerVer \[ glob -tails -directory ${VERSION_PREFIX}/${Compiler} -type d \* ]cray-impi/1.1.4(154):ERROR:102: Tcl command execution failed: set CompilerVer \[ glob -tails -directory ${VERSION_PREFIX}/${Compiler} -type d \* ]cray-impi/1.1.4(154):ERROR:102: Tcl command execution failed: set CompilerVer \[ glob -tails -directory ${VERSION_PREFIX}/${Compiler} -type d \* ]   'craype-x86-skylake' dependent modulefiles were removed       |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

  


단층 리스트 파일을 작성, 혹은 기존에 존재하는 것을 재사용.

단층 리스트 파일은 단층 이름과 각 단층의 베리에이션 (realisation) 갯수를 아래와 같은 포맷으로 기록한 것임.

Busan_faults_list.txt ------------- (2)

fault_list.txt

| Gyeongju 1r |
| ----------- |

  


포항과 경주 단층이 각 1개씩의 realisation을 가지고 있음을 의미함.

고주파 시뮬레이션에 사용할 1D 속도 모델이 아래 위치에 있는지 재확인

/home01/x2319a02/gmsim/VelocityModel/Mod-1D/us_east.1d ------ (3)

현재 사용되는 모델은 이와 같음

| 230.0307 1.7300 1.0000 2.0306 10.00 10.000.0140 2.6832 1.5510 2.1408 35.51 35.510.0553 3.1192 1.8030 2.2766 38.03 38.031.8330 5.1900 3.0000 2.6111 500.00 500.000.8950 5.5770 3.2240 2.6650 500.00 500.002.1720 5.8280 3.3690 2.7000 1500.00 1500.002.1500 6.1760 3.5700 2.7568 2900.00 2900.007.5000 6.1800 3.5700 2.7248 2900.00 2900.0011.0000 6.3600 3.6800 2.7811 2900.00 2900.008.0000 7.1200 4.1200 3.0660 2900.00 2900.001.0000 7.1500 4.1300 3.0520 2900.00 2900.001.2000 7.2600 4.2000 3.0943 2900.00 2900.000.8500 7.6400 4.4200 3.2331 2900.00 2900.000.2000 7.9700 4.6100 3.3533 2900.00 2900.0010.0000 8.1200 4.6900 3.4059 2900.00 2900.0010.0000 8.3500 4.7000 3.4489 2900.00 2900.0010.0000 8.4000 4.7600 3.4775 2900.00 2900.0010.0000 8.4100 4.7800 3.4859 2900.00 2900.0010.0000 8.4200 4.7900 3.4909 2900.00 2900.0010.0000 8.4200 4.8100 3.4976 2900.00 2900.0010.0000 8.4200 4.8300 3.5043 2900.00 2900.0010.0000 8.4200 4.8500 3.5109 2900.00 2900.00999.0000 8.4300 4.8700 3.5193 2900.00 2900.00    |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

사용할 시뮬레이션 레시피와 그 디테일은 아래와 같음

/home01/x2319a02/gmsim/Environments/v211213/workflow/workflow/calculation/gmsim_templates/Busan_22.01.26.1 --- (4)

  


root_defaults.yaml

| hf:version: 5.4.5.3dt: 0.005rvfac: 0.8sdrop: 50path_dur: 1kappa: 0.045bb:fmin: 0.2fmidbot: 0.5no-lf-amp: Trueemod3d:emod3d_version: 3.0.4ims:extended_period: Falsecomponent:\- geompSA_periods: \[0.01, 0.02, 0.03, 0.04, 0.05, 0.075, 0.1, 0.12, 0.15, 0.17, 0.2, 0.25, 0.3, 0.4, 0.5, 0.6, 0.7, 0.75, 0.8, 0.9, 1.0, 1.25, 1.5, 2.0, 2.5, 3.0, 4.0, 5.0, 6.0, 7.5, 10.0]flo: 1.0dt: 0.005v_1d_mod: us_east.1d (&lt;---(3))    |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

emod3d_defaults.yaml도 이 디렉토리에 있으나, 대부분의 경우 디폴트 값을 이용함.

관측소 리스트는 시뮬레이션 도메인을 2km 단위 그리드로 나누고 추가로 아래에 리스팅한 실제 관측소와 주요 시설의 좌표를 추가하여 만들어진 파일을 이용할 것임

/scratch/x2319a02/gmsim/Busan_Data/Stations/Busan_2km_stats_20220314.ll ------ (5)

동일 디렉토리에 Busan_2km_stats_20220314.vs30, Busan_2km_stats_20220314.vs30ref 파일도 함께 존재하여야 함.

(이 파일을 만든 방법은 아래에서 설명할 것임.)

| ...   127.8790 35.4131 SACA127.8946 34.9832 GMNA127.9188 35.6140 KCH2127.9261 34.8167 NAHA127.9441 36.4413 HWSA128.0402 35.1642 JINA128.0485 35.8754 JGNA128.1016 36.0813 GICA128.1018 35.4137 HACA128.1575 36.4079 SAJB128.1700 35.5652 HCNA128.1928 34.9444 HAIA128.1934 35.7279 YALB128.2880 35.3227 EURB128.2903 36.2347 GUMA128.3071 35.1136 GACA128.3657 35.8532 YGAA128.3813 36.0399 CIGB128.4284 36.3906 DNBA128.4361 34.8452 TOY2128.4779 35.5342 CHRB128.4834 35.0278 YGJA128.4908 35.3629 CLSA128.5725 35.1705 CGWB128.5927 36.1813 GUWB128.6047 34.8885 KUJA128.6704 35.6627 CGDA128.6887 36.3561 EUSB128.7111 36.0502 SNNA128.7174 35.2822 JNYA128.7444 35.4916 MIYA128.7536 35.1122 JNHA128.8280 35.2422 JUCA128.8970 35.7685 DAG2128.9488 36.4121 ADO2128.9511 35.9771 YOCB128.9538 35.5884 MSNA128.9969 35.3113 MLGA129.0109 35.7576 GSNA129.0854 36.3878 CSOA129.1995 36.0689 GIGA129.2151 36.2421 JKJA129.2530 35.9498 GGDA129.3708 36.1930 PHA2129.3865 35.7955 YGBA129.3907 36.3637 GGGA129.5666 36.0761 HMGA129.297235 35.320350 GORI129.158978 35.159055 HWND129.074660 35.180164 CITY129.031131 35.096742 FISH128.945753 35.173075 AERO128.922040 35.136396 ELKO129.082572 35.222247 OCHN    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

  


/scratch/x2319a02/gmsim/Busan_Data/task_config.yaml 에 있는 파일을

시뮬레이션 root인 /scratch/x2319a02/gmsim/RunFolder/Busan20211214 에 복사하고 아래와 같이 수정함

| EMOD3D: ALLHF: ALLBB: ALLIM_calc: ALLclean_up: NONEmerge_ts: ALLplot_ts: ALLIM_plot: ALL |
| ---------------------------------------------------------------------------------------- |

이는 EMOD3D, HF, BB 그리고 IM_calc를 자동으로 실행하고, 계산과정에서 생성되는 임시파일들을 삭제하지 말라는 의미임. 구체적인 각 스텝간의 의존성은 아래 도표와 같다. (굵은 선은 주로 사용되는 것들).

![](https://lh5.googleusercontent.com/A_JGDLSXhGGd7NAdVvosNqpgqGVWX4SyP5EwWd-kyYEquNOg3OcUGchhc55Bd0cUAEGu2NFGZA9rqgxigsJFX_Oe8XeNypa3LiKGms4xsdN5lyYE3tCsUxGFWes3VVwiR9Tf3xv9)

각 스텝들의 의존성에 대한 정보는[qcore/constants.py at master · ucgmsim/qcore (github.com)](https://github.com/ucgmsim/qcore/blob/master/qcore/constants.py) 에서 classProcessType(ExtendedStrEnum)를 참조하도록 하고,위 task_config.yaml에 수정이 필요하다면 아래 링크를 참조할 것.

[Auto submit wrapper - QuakeCoRE: The Centre for Earthquake Resilience - Confluence (canterbury.ac.nz)](https://wiki.canterbury.ac.nz/display/QuakeCore/Auto+submit+wrapper) )


## 시뮬레이션 인스톨

위의 사항들이 충족이 되었다면, 시뮬레이션 인스톨을 시작할 수 있음

cd /scratch/x2319a02/gmsim/RunFolder/Busan20211214

python $gmsim/workflow/workflow/automation/install_scripts/install_cybershake.py \`pwd\` ./fault_list.txt Busan_22.01.26.1 --stat_file_path /scratch/x2319a02/gmsim/Busan_Data/Stations/Busan_2km_stats_20220314.ll --keep_dup_station

위에서 준비한 내용들이 이 명령어에서 어떻게 사용되었나 살펴보자면

python $gmsim/workflow/workflow/automation/install_scripts/install_cybershake.py  
\`pwd\`(&lt;--(1))   
/scratch/x2319a02/gmsim/Busan_Data/busan_faults_list.txt(&lt;---(2))

Busan_21.10.18.1(&lt;---(4))

\--stat_file_path /scratch/x2319a02/gmsim/Busan_Data/Stations/Busan_2km_stats_20220314.ll(&lt;-- (5))

\--keep_dup_station

  


\--keep_dup_station은 혹시 같은 위치의 관측점이 다른 이름으로 존재할 경우라도 상관하지 말라는 의미임.  
  


| 참고:처음 실행할 때 아래와 같은 에러가 발생하며 중단될 수 있음.Error: VM Pohang failed VM extents not contained within NZVM DEM: 130.36976143733443, 37.36407162688109VM extents not contained within NZVM DEM: 127.54403856266556, 37.36407162688109VM extents not contained within NZVM DEM: 127.60603497578211, 33.77116521934643VM extents not contained within NZVM DEM: 130.3077650242179, 33.77116521934643 VM extents not contained within NZVM DEM: 127.607221, 33.771972VM extents not contained within NZVM DEM: 127.545307, 37.363293VM extents not contained within NZVM DEM: 130.368482, 37.363293VM extents not contained within NZVM DEM: 130.306569, 33.771972$gmsim/workflow/workflow/automation/install_scripts/install_cybershake_fault.py의 라인 173에서 시뮬레이션 위치가 뉴질랜드 영토인지 체크하는 부분 때문에 에러가 발생한 것으로 코드를 수정하여 무시하도록 하면 됨.    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

  


결과:

| 2021-10-21 06:47:31,638 - Installing /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Data/Sources/Pohang/Srf/Pohang.srf\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*2021-10-21 06:47:31,660 - installing bb\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*2021-10-21 06:47:31,660 - EMOD3D HF/BB Preparation Ver.slurm\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*2021-10-21 06:47:31,660 - installing bb finished2021-10-21 06:47:31,749 - /scratch/x2319a02/gmsim/Busan_Data/Stations/Busan_2km_stats_20220314.ll2021-10-21 06:47:31,749 - From: /scratch/x2319a02/gmsim/Busan_Data/Stations/Busan_2km_stats_20220314.ll. To: /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Pohang/fd_rt01-h0.100.statcords, /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Pohang/fd_rt01-h0.100.llError: VM Gyeongju failed VM extents not contained within NZVM DEM: 130.36976143733443, 37.36407162688109VM extents not contained within NZVM DEM: 127.54403856266556, 37.36407162688109VM extents not contained within NZVM DEM: 127.60603497578211, 33.77116521934643VM extents not contained within NZVM DEM: 130.3077650242179, 33.77116521934643 VM extents not contained within NZVM DEM: 127.607221, 33.771972VM extents not contained within NZVM DEM: 127.545307, 37.363293VM extents not contained within NZVM DEM: 130.368482, 37.363293VM extents not contained within NZVM DEM: 130.306569, 33.7719722021-10-21 06:48:21,032 - Installing /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Data/Sources/Gyeongju/Srf/Gyeongju.srf\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*2021-10-21 06:48:21,047 - installing bb\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*2021-10-21 06:48:21,047 - EMOD3D HF/BB Preparation Ver.slurm\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*2021-10-21 06:48:21,047 - installing bb finished2021-10-21 06:48:21,105 - /scratch/x2319a02/gmsim/Busan_Data/Stations/Busan_2km_stats_20220314.ll2021-10-21 06:48:21,105 - From: /scratch/x2319a02/gmsim/Busan_Data/Stations/Busan_2km_stats_20220314.ll. To: /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Gyeongju/fd_rt01-h0.100.statcords, /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Gyeongju/fd_rt01-h0.100.ll    |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

시뮬레이션 실행 디렉토리에 인스톨이 끝나면 아래와 같은 디렉토리 구조를 가지게 됨

  


| /scratch/x2319a02/gmsim/RunFolder/Busan20211214\|-slurm_mgmt.db\|-install_cybershake_log_20211021_064613.txt\|-mgmt_db_queue\|-Data\|-Runs\| \|-Pohang\| \| \|-Pohang\| \| \| \|-LF\| \| \| \|-HF\| \| \| \|-IM_calc\| \| \| \|-sim_params.yaml\| \| \| \|-BB\| \| \|-fd_rt01-h0.100.statcords\| \| \|-fd_rt01-h0.100.ll\| \| \|-fault_params.yaml\| \|-root_params.yaml\| \|-Gyeongju\| \| \|-fd_rt01-h0.100.statcords\| \| \|-Gyeongju\| \| \| \|-LF\| \| \| \|-HF\| \| \| \|-IM_calc\| \| \| \|-sim_params.yaml\| \| \| \|-BB\| \| \|-fd_rt01-h0.100.ll\| \| \|-fault_params.yaml    |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |


## 시뮬레이션 실행

Cybershake 워크플로우를 인스톨하면 자동화 스케쥴러를 사용할 수 있다. 이 스케쥴러는 로그인 노드에서 상주하며 실행 중인 job을 모니터하고, 의존 관계에 있는 job들이 성공적으로 완료되면 그 다음 단계의 job을 자동으로 submit하는 기능이 있다.

누리온의 로그인 노드가 접속 중 활동이 없으면 네트워크 연결을 끊어버리는 경우가 많아 타임아웃 무제한으로 만들고 스크린 세션안에서 실행하는 것을 권장한다.

export TMOUT= (= 다음에 아무 것도 추가하지 않고 엔터.)

screen을 실행하고 나면 가상 환경이 사라지게 되므로 다시 한번 활성화 해준다.

activate_env /home01/x2319a02/gmsim/Environments/v211213/

cd /scratch/x2319a02/gmsim/RunFolder/Busan20211214

  
python $gmsim/workflow/workflow/automation/execution_scripts/run_cybershake.py \`pwd\` $USER \`pwd\`/task_config.yaml

마지막 task_config.yaml은 옵션이며, 지정해 주지 않으면 EMOD3D,HF,BB 그리고 IM_calc를 실행한 후에 임시파일을 모두 삭제하는 디폴트값이 사용된다.

| 2021-10-21 06:54:48,113 - MainThread - Logger file added2021-10-21 06:54:48,138 - MainThread - Master script will run \[&lt;ProcessType.EMOD3D: 1>, &lt;ProcessType.HF: 4>, &lt;ProcessType.BB: 5>, &lt;ProcessType.IM_calculation: 6>, &lt;ProcessType.clean_up: 11>]2021-10-21 06:54:48,143 - MainThread - Created queue_monitor thread2021-10-21 06:54:48,143 - MainThread - Created main auto_submit thread2021-10-21 06:54:48,144 - MainThread - Started main auto_submit thread2021-10-21 06:54:48,145 - queue monitor - Running queue-monitor, exit with Ctrl-C.2021-10-21 06:54:48,145 - MainThread - Started queue_monitor thread2021-10-21 06:54:48,158 - main auto submit - Loaded root params file: /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/root_params.yaml2021-10-21 06:54:48,379 - main auto submit - Number of runnable tasks: 42021-10-21 06:54:48,380 - main auto submit - Tasks to run this iteration: Pohang-EMOD3D, Pohang-HF, Gyeongju-EMOD3D, Gyeongju-HF2021-10-21 06:54:48,866 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:54:48,870 - queue monitor - No entries in the mgmt db queue.submit_time not in proc_Data.keys(),value 2021-10-21_06:54:48submit_time not in proc_Data.keys(),value 2021-10-21_06:54:49submit_time not in proc_Data.keys(),value 2021-10-21_06:54:50submit_time not in proc_Data.keys(),value 2021-10-21_06:54:512021-10-21 06:54:54,168 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:54:54,176 - queue monitor - Updating 4 mgmt db tasks.2021-10-21 06:54:54,176 - queue monitor - Acquiring db connection.… (중간 생략)2021-10-21 06:55:22,120 - queue monitor - No entries in the mgmt db queue.2021-10-21 06:55:27,403 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:55:27,405 - queue monitor - In progress tasks in mgmt db:Pohang-EMOD3D-9169423-running, Pohang-HF-9169424-running, Gyeongju-EMOD3D-9169425-running, Gyeongju-HF-9169426-running2021-10-21 06:55:27,408 - queue monitor - No entries in the mgmt db queue.2021-10-21 06:55:32,686 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:55:32,689 - queue monitor - In progress tasks in mgmt db:Pohang-EMOD3D-9169423-running, Pohang-HF-9169424-running, Gyeongju-EMOD3D-9169425-running, Gyeongju-HF-9169426-running2021-10-21 06:55:32,705 - queue monitor - Updating 2 mgmt db tasks.2021-10-21 06:55:37,991 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:55:37,992 - queue monitor - In progress tasks in mgmt db:Pohang-EMOD3D-9169423-running, Pohang-HF-9169424-running, Gyeongju-EMOD3D-9169425-running, Gyeongju-HF-9169426-running2021-10-21 06:55:38,001 - queue monitor - Updating 2 mgmt db tasks.2021-10-21 06:55:43,275 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:55:43,278 - queue monitor - In progress tasks in mgmt db:Pohang-EMOD3D-9169423-running, Pohang-HF-9169424-running, Gyeongju-EMOD3D-9169425-running, Gyeongju-HF-9169426-running2021-10-21 06:55:43,284 - queue monitor - No entries in the mgmt db queue.2021-10-21 06:55:48,568 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:55:48,570 - queue monitor - In progress tasks in mgmt db:Pohang-EMOD3D-9169423-running, Pohang-HF-9169424-running, Gyeongju-EMOD3D-9169425-running, Gyeongju-HF-9169426-running2021-10-21 06:55:48,572 - queue monitor - No entries in the mgmt db queue.2021-10-21 06:55:53,852 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:55:53,854 - queue monitor - In progress tasks in mgmt db:Pohang-EMOD3D-9169423-running, Pohang-HF-9169424-running, Gyeongju-EMOD3D-9169425-running, Gyeongju-HF-9169426-running2021-10-21 06:55:53,856 - queue monitor - No entries in the mgmt db queue.2021-10-21 06:55:59,208 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-21 06:55:59,210 - queue monitor - In progress tasks in mgmt db:Pohang-EMOD3D-9169423-running, Pohang-HF-9169424-running, Gyeongju-EMOD3D-9169425-running, Gyeongju-HF-9169426-running    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

마지막 라인은 Pohang과 Gyeongju의 EMOD3D와 HF job들이 현재 진행중임을 알려줌

Ctrl+a d로 스크린을 detach한뒤 qstat으로 현재 상태를 알아볼 수 있다.

(python3_nurion) x2319a02@login04:/scratch/x2319a02/gmsim/RunFolder/Busan20211214> qstat -u $USER

pbs:

Req'd Req'd Elap

Job ID Username Queue Jobname SessID NDS TSK Memory Time S Time

\-------------------- -------- -------- ---------- ------ --- --- ------ ----- - -----

9169423.pbs x2319a02 normal emod3d.Po\* 12259 20 13\* -- 18:30 R 00:01

9169424.pbs x2319a02 normal hf.Pohang 29495 1 68 -- 00:30 R 00:01

9169425.pbs x2319a02 normal emod3d.Gy\* 25158 20 13\* -- 18:30 R 00:01

9169426.pbs x2319a02 normal hf.Gyeong\* 40822 1 68 -- 00:30 R 00:01

  


위에서 살펴본 바와 같이 Cybershake 실행할 때 제공한 task_config.yaml에서 요청한 바에 따라 워크플로우는 인스톨된 단층모델들, Pohang, Gyeongju의 각 1개씩의 realisation의 저주파(LF, 주로 EMOD3D로 불리움), 고주파(HF), BB (broadband = LF+HF) 등의 job을 누리온에 자동으로 submit하고 각 job의 진행상황을 모니터함과 동시에,의존도가 충족되면 다음 단계의 job을 다시 submit하고 모니터링한다.

job을 서브밋할 때, 필요한 리소스와 wallclock 같은 변수도 자동으로 예상하여 그 값을 사용하는데, 만약 작업시간이 예상을 초과하여 계산이 중단되면, 예상시간을 늘여서 다시 서브밋하도록 제작되어 있음. (2차 시도는 시간 2배, 3차 시도는 시간 3배..)

위와 같은 이유로 시뮬레이션이 아직 안정화되지 못한 경우, 다양한 이유로 job이 실패할 수 있으나 그럴 때마다 예상시간을 늘이며 다시 서브밋된다면 누리온 계정의 allocation을 낭비하게 될 수도 있음. 따라서 이 워크플로우는 시뮬레이션이 이미 안정화 단계에 있을 때 사용하는 것을 권장함.

한편, run_cybershake.py는 디폴트값으로 최고 2번의 시도를 하도록 되어 있으며, 이 값은 --n_max_retries 스위치로 조절 가능함


### 재시도

만약 정해진 횟수 내에 어떤 이유로 계산이 성공적으로 완료되지 않았다면, 그 원인을 수정한 다음,--n_max_retries 스위치와 함께다시 run_cybershake.py를 실행하면 된다.  
  
예시) BB를 2회 시도하였으나, .vs30 파일이 지정된 위치에 있지 않은 이유로 run_cybershake.py가 BB를 계산하지 못한 상황에서 종료가 되었다고 가정. 원인을 해결하고, 아래와 같이 --n_max_retries 3 을 주어 재실행시키면 이전의 2회 시도에 이어 한번 더 시도하게 된다.  
  


(python3_nurion) x2319a02@login04:/scratch/x2319a02/gmsim/RunFolder/Busan20211214> python $gmsim/workflow/scripts/cybershake/run_cybershake.py /scratch/x2319a02/gmsim/RunFolder/Busan20211214 $USER**--n_max_retries 3**

  


| 2021-10-22 05:30:08,076 - MainThread - Logger file added2021-10-22 05:30:08,098 - MainThread - Master script will run \[&lt;ProcessType.EMOD3D: 1>, &lt;ProcessType.HF: 4>, &lt;ProcessType.BB: 5>, &lt;ProcessType.IM_calculation: 6>, &lt;ProcessType.clean_up: 11>]2021-10-22 05:30:08,103 - MainThread - Created queue_monitor thread2021-10-22 05:30:08,103 - MainThread - Created main auto_submit thread2021-10-22 05:30:08,104 - MainThread - Started main auto_submit thread2021-10-22 05:30:08,105 - queue monitor - Running queue-monitor, exit with Ctrl-C.2021-10-22 05:30:08,105 - MainThread - Started queue_monitor thread2021-10-22 05:30:08,134 - main auto submit - Loaded root params file: /scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/root_params.yaml2021-10-22 05:30:08,292 - main auto submit - Number of runnable tasks: 22021-10-22 05:30:08,293 - main auto submit - Tasks to run this iteration: Pohang-BB, Gyeongju-BB2021-10-22 05:30:08,646 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 05:30:08,652 - queue monitor - No entries in the mgmt db queue.2021-10-22 05:30:13,930 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 05:30:13,938 - queue monitor - Updating 2 mgmt db tasks.2021-10-22 05:30:13,938 - queue monitor - Acquiring db connection.2021-10-22 05:30:19,231 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 05:30:19,233 - queue monitor - In progress tasks in mgmt db:Pohang-BB-9178917-queued, Gyeongju-BB-9178918-queued2021-10-22 05:30:19,235 - queue monitor - No entries in the mgmt db queue.2021-10-22 05:30:24,538 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 05:30:24,540 - queue monitor - In progress tasks in mgmt db:Pohang-BB-9178917-queued, Gyeongju-BB-9178918-queued2021-10-22 05:30:24,541 - queue monitor - No entries in the mgmt db queue.2021-10-22 05:30:29,824 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 05:30:29,826 - queue monitor - In progress tasks in mgmt db:Pohang-BB-9178917-queued, Gyeongju-BB-9178918-queued2021-10-22 05:30:29,828 - queue monitor - Updating status of Pohang, BB from queued to running2021-10-22 05:30:29,828 - queue monitor - Updating status of Gyeongju, BB from queued to running2021-10-22 05:30:29,828 - queue monitor - Updating 2 mgmt db tasks.2021-10-22 05:30:29,828 - queue monitor - Received entry SchedulerTask(run_name='Pohang', proc_type=5, status=3, job_id=None, error=None), status is more than created but the job_id is not set.2021-10-22 05:30:29,831 - queue monitor - Received entry SchedulerTask(run_name='Gyeongju', proc_type=5, status=3, job_id=None, error=None), status is more than created but the job_id is not set.2021-10-22 05:30:35,784 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 05:30:35,786 - queue monitor - In progress tasks in mgmt db:Pohang-BB-9178917-running, Gyeongju-BB-9178918-running2021-10-22 05:30:35,787 - queue monitor - No entries in the mgmt db queue.2021-10-22 05:30:41,064 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 05:30:41,065 - queue monitor - In progress tasks in mgmt db:Pohang-BB-9178917-running, Gyeongju-BB-9178918-running2021-10-22 05:30:41,067 - queue monitor - No entries in the mgmt db queue.2021-10-22 05:30:46,446 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them   …2021-10-22 09:11:03,531 - queue monitor - In progress tasks in mgmt db:Pohang-IM_calc-9180051-running, Gyeongju-IM_calc-9180113-running2021-10-22 09:11:03,533 - queue monitor - No entries in the mgmt db queue.2021-10-22 09:11:08,794 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 09:11:08,797 - queue monitor - In progress tasks in mgmt db:Pohang-IM_calc-9180051-running, Gyeongju-IM_calc-9180113-running2021-10-22 09:11:08,798 - queue monitor - No entries in the mgmt db queue.2021-10-22 09:11:14,058 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 09:11:14,059 - queue monitor - In progress tasks in mgmt db:Pohang-IM_calc-9180051-running, Gyeongju-IM_calc-9180113-running2021-10-22 09:11:14,061 - queue monitor - No entries in the mgmt db queue.2021-10-22 09:11:19,323 - queue monitor - Over 200 tasks were found in the queue. Check the log for an exact listing of them2021-10-22 09:11:19,325 - queue monitor - In progress tasks in mgmt db:Pohang-IM_calc-9180051-running, Gyeongju-IM_calc-9180113-running2021-10-22 09:11:19,326 - queue monitor - No entries in the mgmt db queue.…2021-10-22 10:02:43,891 - queue monitor - No entries in the mgmt db queue.2021-10-22 10:02:46,918 - main auto submit - Nothing was running or ready to run last cycle, exiting now**2021-10-22 10:02:46,919 - MainThread - The main auto_submit thread has terminated, and all auto_submit patterns have completed a final run through****2021-10-22 10:02:46,920 - MainThread - Attempting to shut down the queue monitor thread****2021-10-22 10:02:48,896 - MainThread - The queue monitor has been shut down successfully**       |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

  


아웃풋 내용을 살펴보면, BB가 완료되고 나서 자동으로 IM_calculation이 서브밋되었고, 마지막 부분을 보면 모든 job들이 성공리에 완료되었음을 파악할 수 있다.  



### job 진행 상태를 파악하기


#### 전체 상황

cd /scratch/x2319a02/gmsim/RunFolder/Busan20211214

python $gmsim/workflow/workflow/automation/execution_scripts/query_mgmt_db.py . --config ./task_config.yaml

|   run_name \| process \| status \| job-id \| last_modified\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_Gyeongju \| EMOD3D \| completed \| 9170922 \| 2021-10-21 04:30:48Gyeongju \| HF \| completed \| 9170923 \| 2021-10-21 02:45:58Gyeongju \| BB \| completed \| 9180006 \| 2021-10-22 00:01:22Gyeongju \| IM_calculation \| completed \| 9180113 \| 2021-10-22 00:52:46Gyeongju \| BB \| failed \| 9171919 \| 2021-10-21 04:32:09Gyeongju \| BB \| failed \| 9171927 \| 2021-10-21 04:33:30Pohang \| EMOD3D \| completed \| 9170920 \| 2021-10-21 04:29:55Pohang \| HF \| completed \| 9170921 \| 2021-10-21 02:45:52Pohang \| BB \| completed \| 9180002 \| 2021-10-22 00:01:22Pohang \| IM_calculation \| completed \| 9180051 \| 2021-10-22 00:52:30Pohang \| BB \| failed \| 9171912 \| 2021-10-21 04:31:27Pohang \| BB \| failed \| 9171922 \| 2021-10-21 04:32:52 |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\--config 옵션을 쓰지 않으면 애초에 지정하지 않아 필요 없는 단계까지 리스트에 포함되어 나와 출력 리스트가 너무 길어지는 경우가 있다. 리스트에서 BB를 2회 실패하고 3회째에 성공적으로 계산을 마치고 연이어 IM_calculation 단계도 성공했음을 확인할 수 있다.

각각의 job의 현재 상태를 파악하고 싶다면 screen을 잠시 빠져나오거나 (detach, Ctrl+a d), 다른 터미널에서 아래와 같은 방법을 사용할 수 있다.


#### LF (EMOD3D)

LF/Rlog디렉토리에 \*.rlog파일이 업데이트 되는 과정을 관찰하면 됨

| (python3_nurion) x2319a02@login04:/scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Pohang/Pohang/LF/Rlog> tail -f Pohang-00539.rlog\*\*\*\* Dumping wavefield to restart file:/scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Pohang/Pohang/LF/Restart/Pohang_rst-00539.e3d\*\*\*\* Dumping all output files to:/scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Pohang/Pohang/LF/OutBin...DONE2000 30.27 4417.19 1.00 67.07 0.96 1086. 0.992100 16.17 4417.19 1.00 52.03 1.00 1138. 1.002200 16.38 4417.19 1.00 52.49 1.00 1191. 1.002300 15.75 4417.19 1.00 51.98 1.00 1243. 1.002400 15.66 4417.19 1.00 51.89 1.00 1295. 1.00    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

현재까지 timestep 2400을 수행했음을 알려줌.

LF/e3d.par의 nt값을 확인하면 timestep이 12200에 도달할 때까지 계산이 지속되어야 함을 알수 있음.


#### HF

HF/Acc에 HF.bin, HF.log 파일 사이즈가 증가하는 것이 관찰되면 정상적으로 작동하고 있다고 짐작할 수 있음

  


| (python3_nurion) x2319a02@login04:/scratch/x2319a02/gmsim/RunFolder/Busan20211214/Runs/Pohang/Pohang/HF/Acc> ls -ltrtotal 1455080\-rw-rw-r-- 1 x2319a02 re0016 8 Oct 21 09:52 SEED\-rw-rw-r-- 1 x2319a02 re0016 5169992 Oct 21 09:54 HF.log\-rw-rw-r-- 1 x2319a02 re0016 1610809808 Oct 21 09:54 HF.bin |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

계산이 모두 끝나면 LF와 HF 모두 결과값이 원하는 포맷과 일치하는지 간단한 검증 과정을 거친다. 통과하면 Complete로 마크되고 그 다음 단계에 계산할 job이 있다면 (이 경우 BB) submit하게 된다.






# 인풋 모델 만들기

단층, 속도 모델을 만드는 것도 Cybershake 워크플로우에서 커버할 수 있으나, 이 워크플로우는 적은 수의 모델을 실험적으로 생성, 테스트하는 데에는 최적화되어 있지 않으므로, 약간의 수작업을 통해 인풋 모델 만드는 방법을 우선 소개함.


## 단층 모델 만들기

TO DO: Stoch모델이 만들어질 때, 저장되는 위치가 Stoch/{fault name}/{fault name}.stoch 이 되어버리는 버그가 있다. Stoch/{fault name}.stoch이 맞음 (setSrfParams.py에서 STOCH=Stoch 이면 정상 작동)

setSrfParams.py 을 수정한 다음 createSRF.py를 실행

| \## Sets Variables for SRF/Stoch Generation\# TYPE:\# 1: point source to point source srf\# 2: point source to finite fault srf\# 3: finite fault to finite fault srf\# 4: multi-segment finite fault srfTYPE = 2\# specify basename for gsf, srf and stoch file created\# PREFIX for gsf/srf/stoch files\# if prefix ends with '\_', automatic naming followsPREFIX = 'Srf/Gyeongju'\# directory for Stoch file(s)\# set to None to not produce the stoch fileSTOCH = 'Stoch/Gyeongju'\###\### COMMON PARAMETERS (apply to all types but multi)\###\# latitude (float)LAT = 35.79\# longitude (float)LON = 129.12\# depth (float)DEPTH = 20\# magnitude (float)MAG = 5.8\# strike (int)STK = 24\# dip (int)DIP = 70\# rake (int)RAK = 176\# rupture timestepDT = 0.01       |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |





## 속도 모델 만들기


### 준비

NZVM code에서 부산 분지 모델이 추가된 버전의 바이너리 위치는  
  


/home01/hpc11a04/gmsim/VM_KVM/Velocity-Model-Viz/Velocity-Model/NZVM (2021년 Oct 4 build) (To do: github 에서 maintain)

  


/scratch/x2319a02/gmsim/Busan_Data/Data/VMs/Pohang/vm_params.yaml 을 적절히 수정해서 사용

| mag: 5.5centroidDepth: 4.05399MODEL_LAT: 35.5755MODEL_LON: 128.9569MODEL_ROT: 0.0hh: 0.1min_vs: 0.2model_version: KVM_21p6topo_type: BULLDOZEDoutput_directory: outputextracted_slice_parameters_directory: SliceParametersNZ/SliceParametersExtracted.txtcode: rtextent_x: 250extent_y: 400extent_zmax: 40extent_zmin: 0.0sim_duration: 60flo: 1.0nx: 2500ny: 4000nz: 400sufx: \_rt01-h0.100 |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

model_version: KVM_21p6은 부산 분지 모델이 들어간 버전임을 의미함

hh: 0.1은 그리드 간격이 100m를 의미함

extent_x = hh \* nx

extent_y = hh \* ny

extent_zmax-extent_zmin=hh\*nz

의 관계가 있음

flo = 0.1 / hh 의 상관 관계가 있음

hh=0.1 --> flo: 1.0

hh=0.4 --> flo: 0.25


### 실행  
  


“Pohang2”라는 모델을 만들기로 함.

만약 가상환경이 활성화가 되지 않은 상황이라면,

activate_env /home01/x2319a02/gmsim/Environments/v211213/

디렉토리로 이동하여 아래 순서들을 진행한 후, make_vm.pbs를 서브밋한다.

cd /scratch/x2319a02/gmsim/Busan_Data/Data/VMs

mkdir Pohang2

cd Pohang2

cp /scratch/x2319a02/gmsim/Busan_Data/Data/VMs/Pohang/vm_params.yaml .

(편집, 수정)  
  


cp /scratch/x2319a02/gmsim/Busan_Data/utils/VM/\* .

make_vm.pbs 파일을 체크하고 올바른 버전의 NZVM 바이너리가 사용되는지 확인. Walltime 은 남한 대부분을 커버하는 100m 모델의 경우 10시간 정도 세팅이 적당함

​​  
  


qsub -v REL_NAME=Pohang2,VM_PARAMS_YAML=\`pwd\`/vm_params.yaml,OUTPUT_DIR=\`pwd\` -V /scratch/x2319a02/gmsim/Busan_Data/utils/VM/make_vm.pbs

qsub -v VM_PARAMS_YAML=\`pwd\`/vm_params.yaml,OUTPUT_DIR=\`pwd\`,REL_NAME=Busan -V /scratch/x2319a02/gmsim/Busan_Data/utils/VM/make_vm.pbs


### 진행상황 체크

(python3_nurion) x2319a02@login04:/scratch/x2319a02/gmsim/Busan_Data/Data/VMs/Pohang2> qstat -u $USER

pbs:

Req'd Req'd Elap

Job ID Username Queue Jobname SessID NDS TSK Memory Time S Time

\-------------------- -------- -------- ---------- ------ --- --- ------ ----- - -----

9180242.pbs x2319a02 normal NZVM 15846 1 68 -- 04:00 R 00:04

Job ID를 참고하여, 현재 $HOME 디렉토리에서 임시로 쓰여지고 있는 아웃풋 파일의 업데이트 상황을 모니터할 수 있다

(python3_nurion) x2319a02@login04:/scratch/x2319a02/gmsim/Busan_Data/Data/VMs/Pohang2> tail -f $HOME/pbs.9180242.pbs.x8z/9180242.pbs.OU

Completed loading of global surfaces.

Loading basin data.

Loading KVM_21p6 perturbation files.

Completed Loading of perturbation files.

All basin surfaces loaded.

All basin boundaries loaded.

All basin sub model data loaded.

Completed loading basin data.

All global data loaded.

Generating velocity model3% complete.


### 생성파일 체크

위에서 서브밋한 pbs스크립트는 64코어를 이용해 NZVM을 실행시켜 \*.p, \*.s, \*.d 파일을 생성시키고, gen_coords.py를 불러 model_params, model_bounds, model_params 등과 같은 좌표 파일들을 도메인에 맞게 생성해낸다. 아래와 같은 파일들이 최종적으로 디렉토리에 상주하게 됨

  


|  \|-VMs\| \|-Pohang2\| \| \|-vm_params.yaml\| \| \|-nzvm.cfg\| \| \|-vp3dfile.p\| \| \|-vs3dfile.s\| \| \|-rho3dfile.d\| \| \|-in_basin_mask.b\| \| \|-model_bounds_rt01-h0.100\| \| \|-model_coords_rt01-h0.100\| \| \|-model_params_rt01-h0.100\| \| \|-gridfile_rt01-h0.100\| \| \|-gridout_rt01-h0.100\| \| \|-VeloModCorners.txt |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |


## 관측소 리스트 만들기

속도모델을 생성하는 과정에서 부산물로 만들어지는 model_coords파일은 그리드 위의 좌표점들의 리스트이므로 이 것을 기반으로 시뮬레이션 관측점 리스트를 작성하기로 결정하였다. 하지만 위에서 생성한 model_coords파일은 hh=0.1으로, 100미터마다, 총 관측점이 1천만개에 달하여 시뮬레이션의 해상도를 필요이상으로 요구하게 되었다. 적절한 타협점으로 hh=2.0에서 25,000개의 관측점 좌표를 생성하게 되었다.  
  
python $gmsim/Pre-processing/VM/gen_coords.py .  
  


이 프로그램은 지정한 디렉토리 (이 경우 “.”)에서 vm_params.yaml을 찾아 지정한 값들에 맞추어 좌표파일들을 생성한다.

hh=2.0 에 맞추어 수정한 vm_params.yaml파일은 아래와 같다.

| mag: 5.5centroidDepth: 4.05399MODEL_LAT: 35.5755MODEL_LON: 128.9569MODEL_ROT: 0.0**hh: 2.0**min_vs: 0.2model_version: KVM_21p6topo_type: BULLDOZEDoutput_directory: outputextracted_slice_parameters_directory: SliceParametersNZ/SliceParametersExtracted.txtcode: rtextent_x: 250extent_y: 400extent_zmax: 40extent_zmin: 0.0sim_duration: 60**flo: 0.05****nx: 125****ny: 200****nz: 20**sufx: \_rt01-h2.000 |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

실행 후, 생성된 model_coords_rt01-h2.000을 아래와 같이 스테이션 리스트 파일로 바꿀수 있다.

/scratch/x2319a02/gmsim/Busan_Data/utils/VM/get_ll.sh ./model_coords_rt01-h2.000 Busan_2km_stats_20211018

Busan_2km_stats_20211018.ll

| 127.55618 37.35489 000000127.57877 37.35515 000001127.60136 37.35541 000002127.62395 37.35567 000003127.64655 37.35592 000004127.66913 37.35617 000005127.69171 37.35641 000006127.71431 37.35665 000007127.73691 37.35688 000008127.75949 37.35711 000009127.78207 37.35734 00000A127.80467 37.35756 00000B…130.03720 33.78315 00619B130.05881 33.78296 00619C130.08040 33.78276 00619D130.10201 33.78257 00619E130.12361 33.78236 00619F130.14522 33.78216 0061A0130.16682 33.78195 0061A1130.18842 33.78173 0061A2130.21002 33.78152 0061A3130.23163 33.78130 0061A4130.25323 33.78107 0061A5130.27484 33.78085 0061A6130.29645 33.78062 0061A7    |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

  


여기에 실존하는 관측점이나 관심 시설의 좌표를 추가하여 관측점 리스트를 완성하면 된다.

제일 아래에 빈 줄이 있으면 인스톨시에 에러가 뜨니 주의할 것

Vs30

extract_Vs30.py

관측 데이터 IM calc

python $gmsim/IM_calculation/IM_calculation/scripts/calculate_ims.py Obs_Acc a -o Obs_IM -np 40 -i Gyeongju -r Gyeongju -t s -c geom -s -p 0.01 0.02 0.03 0.04 0.05 0.075 0.1 0.12 0.15 0.17 0.2 0.25 0.3 0.4 0.5 0.6 0.7 0.75 0.8 0.9 1.0 1.25 1.5 2.0 2.5 3.0 4.0 5.0 6.0 7.5 10.0


# 시각화

누리온 로긴 노드에서 직접 다양한 지도들을 생성할 수 있다.

IM_Calculation단계를 거쳐야 함.시뮬레이션 디렉토리에서 IM_calc디렉토리에 \*.csv파일이 존재하는 지 확인할 것.

  


IM Calculation 결과와 관측점의 위도/경도를 매칭해서 xyz파일을 생성해낸다.

IM_calc의 parent 디렉토리 (LF,HF,BB등이 있는 곳)로 가서 아래를 실행시킴

FAULT=Pohang

REL=Pohang

python $gmsim/visualization/im/spatialise_im.py IM_calc/${REL}.csv ../fd_rt01-h0.100.ll -o plot

위에서 non_uniform_im.xyz파일이 plot이라는 디렉토리에 생성되었을 것임. 아울러 im_order.txt라는 파일도 생겨나는데, 계산된 IM들의 순서가 기록된 파일임.

  
plot 디렉토리에 가서 아래 명령어를 입력. FAULT와 REL을 위처럼 변수로 지정해주면 다른 시뮬레이션 결과값에 대응할 수 있다.  
  


cd plot

python $gmsim/visualization/sources/plot_items.py -c**../../../../Data/Sources/${FAULT}/Srf/${REL}.srf** --xyz non_uniform_im.xyz -t **${FAULT}** --xyz-cpt-label \`cat im_order.txt\` -f **${FAULT}** --xyz-landmask --xyz-cpt hot --xyz-transparency 30 --xyz-grid --xyz-grid-contours --xyz-grid-search 12m --xyz-size 1k --xyz-cpt-invert --xyz-model-params **../../../../Data/VMs/${FAULT}/model_params_rt01-h0.100** -n 4

  
  


Plot_ts

자동으로 실행되도록 되어 있으나 (task_config.yaml) 현재 아래 문제로 종종 자동 실행이 안되는 경우가 있음.

  


| Traceback (most recent call last):File "/home01/x2319a02/gmsim/Environments/v211213//workflow/workflow/automation/execution_scripts/add_to_mgmt_queue.py", line 6, in &lt;module>from workflow.automation.lib.shared_automated_workflow import add_to_queueModuleNotFoundError: No module named 'workflow.automation'    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

수동으로 실행해야 할 경우, 인스톨 시킨 디렉토리로 돌아가서 (Runs와 Data디렉토리를 포함한 곳) 아래를 실행

qsub -v XYTS_PATH=Runs/${FAULT}/${REL}/LF/OutBin/${REL}\_xyts.e3d,SRF_PATH=Data/Sources/${FAULT}/Srf/${REL}.srf,OUTPUT_TS_PATH=Runs/${FAULT}/${REL}/verification/${REL},MGMT_DB_LOC=\`pwd\`,SRF_NAME="${REL}" -V $gmsim/workflow/workflow/automation/org/kisti/plot_ts.pbs


# 참고 문헌:

[Ground motion simulation run manual (20p07) - QuakeCoRE: The Centre for Earthquake Resilience - Confluence (canterbury.ac.nz)](https://wiki.canterbury.ac.nz/pages/viewpage.action?pageId=90538503)

  
  


참고: 데이터 이전 이후 망가진 심볼릭 링크 고치는 법

Old_id=hpc11a02

New_id=x2319a02

라고 가정

Busan\* 이라는 디렉토리 내의 모든 망가진 심볼릭 링크를 찾아서 고치기를 원한다면, 아래 명령어를 적절히 수정하여 실행하면 됨.

find Busan\* -type l|xargs -I{} ls -al {} |grep**x2319a02** |awk '{print $9" "$11}' >links.txt

cat links.txt | while read line; do word=( $line ); dest=${word\[0]}; old_link=${word\[1]}; new_link=${word\[1]}; new_link=${new_link/**hpc11a02**/**x2319a02**}; echo $new_link; rm done

  


특정 text를 포함하는 모든 파일들을 찾아 그 속의 text를 새로운 것으로 바꾸는 법

(python3_nurion) x2319a02@login01:~/gmsim/Environments/v211213> grep -r hpc11a02 \* |grep -v pyc |grep -v Binary |cut -d: -f1 |xargs -I {} sed -i 's/hpc11a02/x2319a02/g' {}

  
  
  
  
